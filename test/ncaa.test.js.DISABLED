// ------------------------------------------------------------------------------
// ncaa.test.js
// Comprehensive NCAA shorthand testing
// Tests all NCAA sport shorthands with various endpoints and teams
// ------------------------------------------------------------------------------

const http = require('http');
const fs = require('fs');
const path = require('path');

// Configuration
const PORT = 3004; // Different port from other tests
const BASE_URL = `http://localhost:${PORT}`;
const OUTPUT_DIR = path.join(__dirname, 'output');
const RESULTS_FILE = path.join(OUTPUT_DIR, 'ncaa-results.json');
const TIMEOUT = 15000;
const RATE_LIMIT_DELAY = 300; // 300ms between requests to respect rate limits

// Test results tracking
const results = {
    suiteName: 'NCAA Shorthand Tests',
    timestamp: new Date().toISOString(),
    totalTests: 0,
    passed: 0,
    failed: 0,
    tests: []
};

// NCAA shorthand mappings with test teams
const NCAA_SHORTHANDS = [
    // Men's sports
    { shorthand: 'football', league: 'ncaaf', name: 'NCAA Football', testTeam: 'alabama' },
    { shorthand: 'footballm', league: 'ncaaf', name: 'NCAA Football', testTeam: 'georgia' },
    { shorthand: 'basketball', league: 'ncaam', name: 'NCAA Men\'s Basketball', testTeam: 'duke' },
    { shorthand: 'basketballm', league: 'ncaam', name: 'NCAA Men\'s Basketball', testTeam: 'kentucky' },
    { shorthand: 'march-madness', league: 'ncaam', name: 'NCAA Men\'s Basketball', testTeam: 'kansas' },
    { shorthand: 'baseball', league: 'ncaabb', name: 'NCAA Baseball', testTeam: 'vanderbilt' },
    { shorthand: 'baseballm', league: 'ncaabb', name: 'NCAA Baseball', testTeam: 'lsu' },
    { shorthand: 'hockey', league: 'ncaah', name: 'NCAA Ice Hockey', testTeam: 'denver' },
    { shorthand: 'ice-hockey', league: 'ncaah', name: 'NCAA Ice Hockey', testTeam: 'minnesota' },
    { shorthand: 'hockeym', league: 'ncaah', name: 'NCAA Ice Hockey', testTeam: 'michigan' },
    { shorthand: 'soccer', league: 'ncaas', name: 'NCAA Soccer', testTeam: 'indiana' },
    { shorthand: 'soccerm', league: 'ncaas', name: 'NCAA Soccer', testTeam: 'stanford' },
    { shorthand: 'lacrosse', league: 'ncaalax', name: 'NCAA Men\'s Lacrosse', testTeam: 'syracuse' },
    { shorthand: 'lacrossem', league: 'ncaalax', name: 'NCAA Men\'s Lacrosse', testTeam: 'virginia' },
    { shorthand: 'mens-lacrosse', league: 'ncaalax', name: 'NCAA Men\'s Lacrosse', testTeam: 'maryland' },
    { shorthand: 'volleyball', league: 'ncaavb', name: 'NCAA Men\'s Volleyball', testTeam: 'ucla' },
    { shorthand: 'volleyballm', league: 'ncaavb', name: 'NCAA Men\'s Volleyball', testTeam: 'hawaii' },
    { shorthand: 'mens-volleyball', league: 'ncaavb', name: 'NCAA Men\'s Volleyball', testTeam: 'usc' },
    { shorthand: 'water-polo', league: 'ncaawp', name: 'NCAA Men\'s Water Polo', testTeam: 'stanford' },
    { shorthand: 'waterpolo', league: 'ncaawp', name: 'NCAA Men\'s Water Polo', testTeam: 'usc' },
    { shorthand: 'waterpolom', league: 'ncaawp', name: 'NCAA Men\'s Water Polo', testTeam: 'ucla' },
    
    // Women's sports
    { shorthand: 'womens-basketball', league: 'ncaaw', name: 'NCAA Women\'s Basketball', testTeam: 'uconn' },
    { shorthand: 'basketballw', league: 'ncaaw', name: 'NCAA Women\'s Basketball', testTeam: 'south-carolina' },
    { shorthand: 'womens-hockey', league: 'ncaawh', name: 'NCAA Women\'s Ice Hockey', testTeam: 'wisconsin' },
    { shorthand: 'hockeyw', league: 'ncaawh', name: 'NCAA Women\'s Ice Hockey', testTeam: 'northeastern' },
    { shorthand: 'softball', league: 'ncaasbw', name: 'NCAA Softball', testTeam: 'oklahoma' },
    { shorthand: 'softballw', league: 'ncaasbw', name: 'NCAA Softball', testTeam: 'ucla' },
    { shorthand: 'womens-soccer', league: 'ncaaws', name: 'NCAA Women\'s Soccer', testTeam: 'stanford' },
    { shorthand: 'soccerw', league: 'ncaaws', name: 'NCAA Women\'s Soccer', testTeam: 'florida-state' },
    { shorthand: 'womens-lacrosse', league: 'ncaawlax', name: 'NCAA Women\'s Lacrosse', testTeam: 'maryland' },
    { shorthand: 'lacrossew', league: 'ncaawlax', name: 'NCAA Women\'s Lacrosse', testTeam: 'syracuse' },
    { shorthand: 'womens-volleyball', league: 'ncaawvb', name: 'NCAA Women\'s Volleyball', testTeam: 'stanford' },
    { shorthand: 'volleyballw', league: 'ncaawvb', name: 'NCAA Women\'s Volleyball', testTeam: 'penn-state' },
    { shorthand: 'womens-water-polo', league: 'ncaawwp', name: 'NCAA Women\'s Water Polo', testTeam: 'stanford' },
    { shorthand: 'waterpolow', league: 'ncaawwp', name: 'NCAA Women\'s Water Polo', testTeam: 'usc' },
    { shorthand: 'field-hockey', league: 'ncaawfh', name: 'NCAA Women\'s Field Hockey', testTeam: 'north-carolina' },
    { shorthand: 'fieldhockey', league: 'ncaawfh', name: 'NCAA Women\'s Field Hockey', testTeam: 'maryland' },
    { shorthand: 'womens-field-hockey', league: 'ncaawfh', name: 'NCAA Women\'s Field Hockey', testTeam: 'princeton' }
];

// Endpoint types to test
const ENDPOINT_TYPES = [
    'raw',
    'logo',
    'thumb',
    'cover',
    'teamlogo',
    'leaguelogo',
    'leaguethumb',
    'leaguecover'
];

// Ensure output directory exists
if (!fs.existsSync(OUTPUT_DIR)) {
    fs.mkdirSync(OUTPUT_DIR, { recursive: true });
}

// ------------------------------------------------------------------------------
// Helper Functions
// ------------------------------------------------------------------------------

function makeRequest(url, timeout = TIMEOUT) {
    return new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
            reject(new Error(`Request timeout after ${timeout}ms`));
        }, timeout);

        http.get(url, (res) => {
            clearTimeout(timeoutId);
            
            const chunks = [];
            res.on('data', chunk => chunks.push(chunk));
            res.on('end', () => {
                const buffer = Buffer.concat(chunks);
                resolve({
                    statusCode: res.statusCode,
                    contentType: res.headers['content-type'],
                    body: buffer
                });
            });
        }).on('error', (err) => {
            clearTimeout(timeoutId);
            reject(err);
        });
    });
}

function waitForServer(maxAttempts = 30, delayMs = 1000) {
    return new Promise((resolve, reject) => {
        let attempts = 0;

        const checkServer = () => {
            attempts++;
            http.get(`${BASE_URL}/health`, (res) => {
                if (res.statusCode === 200) {
                    resolve();
                } else if (attempts < maxAttempts) {
                    setTimeout(checkServer, delayMs);
                } else {
                    reject(new Error('Server failed to start'));
                }
            }).on('error', () => {
                if (attempts < maxAttempts) {
                    setTimeout(checkServer, delayMs);
                } else {
                    reject(new Error('Server failed to start'));
                }
            });
        };

        checkServer();
    });
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function saveResults() {
    const json = JSON.stringify(results, null, 2);
    fs.writeFileSync(RESULTS_FILE, json);
    console.log(`\nðŸ“„ Results saved to: ${RESULTS_FILE}`);
}

// ------------------------------------------------------------------------------
// Test Functions
// ------------------------------------------------------------------------------

async function testNcaaRaw(shorthand, expectedLeague, expectedName) {
    const testResult = {
        name: `NCAA Raw - /ncaa/${shorthand}/raw â†’ ${expectedName}`,
        endpoint: `/ncaa/${shorthand}/raw`,
        passed: false,
        error: null,
        statusCode: null,
        contentType: null,
        duration: 0
    };

    const startTime = Date.now();

    try {
        const response = await makeRequest(`${BASE_URL}/ncaa/${encodeURIComponent(shorthand)}/raw`);
        testResult.statusCode = response.statusCode;
        testResult.contentType = response.contentType;
        testResult.duration = Date.now() - startTime;

        if (response.statusCode !== 200) {
            throw new Error(`Expected 200, got ${response.statusCode}`);
        }

        if (!response.contentType?.includes('application/json')) {
            throw new Error(`Expected application/json, got ${response.contentType}`);
        }

        const data = JSON.parse(response.body.toString());
        
        if (!data.name) {
            throw new Error('Missing league name in response');
        }

        if (data.name !== expectedName) {
            throw new Error(`Expected league name "${expectedName}", got "${data.name}"`);
        }

        testResult.passed = true;
    } catch (error) {
        testResult.error = error.message;
        testResult.duration = Date.now() - startTime;
    }

    return testResult;
}

async function testNcaaTeamEndpoint(shorthand, team, endpointType, expectedLeague) {
    const endpoint = `/ncaa/${shorthand}/${team}/${endpointType}`;
    const testResult = {
        name: `NCAA ${endpointType} - /ncaa/${shorthand}/${team}/${endpointType}`,
        endpoint: endpoint,
        passed: false,
        error: null,
        statusCode: null,
        contentType: null,
        duration: 0
    };

    const startTime = Date.now();

    try {
        const response = await makeRequest(`${BASE_URL}${endpoint}`);
        testResult.statusCode = response.statusCode;
        testResult.contentType = response.contentType;
        testResult.duration = Date.now() - startTime;

        if (response.statusCode !== 200) {
            throw new Error(`Expected 200, got ${response.statusCode}`);
        }

        // Check content type based on endpoint
        if (endpointType === 'raw') {
            if (!response.contentType?.includes('application/json')) {
                throw new Error(`Expected application/json, got ${response.contentType}`);
            }
        } else {
            if (!response.contentType?.includes('image/png')) {
                throw new Error(`Expected image/png, got ${response.contentType}`);
            }
            
            // Verify it's a valid PNG
            if (!response.body.slice(0, 8).equals(Buffer.from([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]))) {
                throw new Error('Response is not a valid PNG image');
            }
        }

        testResult.passed = true;
    } catch (error) {
        testResult.error = error.message;
        testResult.duration = Date.now() - startTime;
    }

    return testResult;
}

async function testNcaaLeagueEndpoint(shorthand, endpointType, expectedLeague) {
    const endpoint = `/ncaa/${shorthand}/${endpointType}`;
    const testResult = {
        name: `NCAA ${endpointType} - /ncaa/${shorthand}/${endpointType}`,
        endpoint: endpoint,
        passed: false,
        error: null,
        statusCode: null,
        contentType: null,
        duration: 0
    };

    const startTime = Date.now();

    try {
        const response = await makeRequest(`${BASE_URL}${endpoint}`);
        testResult.statusCode = response.statusCode;
        testResult.contentType = response.contentType;
        testResult.duration = Date.now() - startTime;

        if (response.statusCode !== 200) {
            throw new Error(`Expected 200, got ${response.statusCode}`);
        }

        // Check content type based on endpoint
        if (endpointType === 'raw') {
            if (!response.contentType?.includes('application/json')) {
                throw new Error(`Expected application/json, got ${response.contentType}`);
            }
        } else {
            if (!response.contentType?.includes('image/png')) {
                throw new Error(`Expected image/png, got ${response.contentType}`);
            }
            
            // Verify it's a valid PNG
            if (!response.body.slice(0, 8).equals(Buffer.from([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]))) {
                throw new Error('Response is not a valid PNG image');
            }
        }

        testResult.passed = true;
    } catch (error) {
        testResult.error = error.message;
        testResult.duration = Date.now() - startTime;
    }

    return testResult;
}

// ------------------------------------------------------------------------------
// Main Test Execution
// ------------------------------------------------------------------------------

async function runAllTests() {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('  NCAA SHORTHAND TESTS');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    console.log('\nâ³ Waiting for server to be ready...');
    await waitForServer();
    console.log('âœ… Server is ready!\n');

    // Calculate total tests
    let totalTests = 0;
    
    // For each shorthand: 1 raw test + team endpoints (logo, thumb, cover, teamlogo) + league endpoints (leaguelogo, leaguethumb, leaguecover)
    totalTests = NCAA_SHORTHANDS.length * 8; // raw + 7 endpoint types with teams/leagues
    
    results.totalTests = totalTests;
    
    console.log(`ðŸ“Š Test Plan:`);
    console.log(`   - ${NCAA_SHORTHANDS.length} NCAA shorthands`);
    console.log(`   - 8 endpoint types per shorthand (raw, logo, thumb, cover, teamlogo, leaguelogo, leaguethumb, leaguecover)`);
    console.log(`   - Total: ${totalTests} tests`);
    console.log(`   - Estimated time: ~${Math.round((totalTests * RATE_LIMIT_DELAY) / 1000 / 60)} minutes\n`);

    let testNumber = 0;

    // Test each NCAA shorthand with all endpoint types
    for (const ncaa of NCAA_SHORTHANDS) {
        console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log(`  Testing: ${ncaa.name} (${ncaa.shorthand})`);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

        // Test 1: Raw endpoint (league-level)
        testNumber++;
        console.log(`\n[${testNumber}/${totalTests}] Testing: /ncaa/${ncaa.shorthand}/raw`);
        const rawResult = await testNcaaRaw(ncaa.shorthand, ncaa.league, ncaa.name);
        results.tests.push(rawResult);
        if (rawResult.passed) {
            results.passed++;
            console.log(`   âœ… PASSED (${rawResult.duration}ms)`);
        } else {
            results.failed++;
            console.log(`   âŒ FAILED: ${rawResult.error} (${rawResult.duration}ms)`);
        }
        await sleep(RATE_LIMIT_DELAY);

        // Test 2-4: Team-based endpoints (logo, thumb, cover)
        for (const endpointType of ['logo', 'thumb', 'cover']) {
            testNumber++;
            console.log(`\n[${testNumber}/${totalTests}] Testing: /ncaa/${ncaa.shorthand}/${ncaa.testTeam}/${endpointType}`);
            const result = await testNcaaTeamEndpoint(ncaa.shorthand, ncaa.testTeam, endpointType, ncaa.league);
            results.tests.push(result);
            if (result.passed) {
                results.passed++;
                console.log(`   âœ… PASSED (${result.duration}ms)`);
            } else {
                results.failed++;
                console.log(`   âŒ FAILED: ${result.error} (${result.duration}ms)`);
            }
            await sleep(RATE_LIMIT_DELAY);
        }

        // Test 5: teamlogo endpoint
        testNumber++;
        console.log(`\n[${testNumber}/${totalTests}] Testing: /ncaa/${ncaa.shorthand}/${ncaa.testTeam}/teamlogo`);
        const teamlogoResult = await testNcaaTeamEndpoint(ncaa.shorthand, ncaa.testTeam, 'teamlogo', ncaa.league);
        results.tests.push(teamlogoResult);
        if (teamlogoResult.passed) {
            results.passed++;
            console.log(`   âœ… PASSED (${teamlogoResult.duration}ms)`);
        } else {
            results.failed++;
            console.log(`   âŒ FAILED: ${teamlogoResult.error} (${teamlogoResult.duration}ms)`);
        }
        await sleep(RATE_LIMIT_DELAY);

        // Test 6-8: League-level endpoints (leaguelogo, leaguethumb, leaguecover)
        for (const endpointType of ['leaguelogo', 'leaguethumb', 'leaguecover']) {
            testNumber++;
            console.log(`\n[${testNumber}/${totalTests}] Testing: /ncaa/${ncaa.shorthand}/${endpointType}`);
            const result = await testNcaaLeagueEndpoint(ncaa.shorthand, endpointType, ncaa.league);
            results.tests.push(result);
            if (result.passed) {
                results.passed++;
                console.log(`   âœ… PASSED (${result.duration}ms)`);
            } else {
                results.failed++;
                console.log(`   âŒ FAILED: ${result.error} (${result.duration}ms)`);
            }
            await sleep(RATE_LIMIT_DELAY);
        }
    }

    // Print summary
    printSummary();

    // Exit with appropriate code
    process.exit(results.failed > 0 ? 1 : 0);
}

// ------------------------------------------------------------------------------
// Summary
// ------------------------------------------------------------------------------

function printSummary() {
    console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('  TEST SUMMARY');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`  Total Tests:  ${results.totalTests}`);
    console.log(`  âœ… Passed:     ${results.passed}`);
    console.log(`  âŒ Failed:     ${results.failed}`);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    if (results.failed > 0) {
        console.log('Failed Tests:');
        results.tests.filter(t => !t.passed).forEach(test => {
            console.log(`  âŒ ${test.name}`);
            console.log(`     Error: ${test.error}`);
        });
        console.log('');
    }

    saveResults();
}

// ------------------------------------------------------------------------------
// Start Server and Run Tests
// ------------------------------------------------------------------------------

if (require.main === module) {
    process.env.PORT = PORT;
    process.env.NODE_ENV = 'development';
    process.env.TRUST_PROXY = '0';
    process.env.RATE_LIMIT_PER_MINUTE = '0'; // Disable rate limiting for tests
    process.env.IMAGE_CACHE_HOURS = '0'; // Disable caching for tests
    process.env.LOG_TO_FILE = 'false';
    process.env.SHOW_TIMESTAMP = 'false';
    process.env.XC_PROXY = 'false'; // Explicitly disable XC proxy
    
    require('../index');
    
    setTimeout(() => {
        runAllTests().catch(error => {
            console.error('\nðŸ’¥ Test suite failed:', error);
            process.exit(1);
        });
    }, 2000);
}

// ------------------------------------------------------------------------------

name: Build & Push Docker Image

on:
    push:
        branches: [ 'dev', 'test/.*' ]
        tags: [ 'v*' ]
        paths-ignore:
          - 'docs/**'
    workflow_dispatch:
        inputs:
            no-cache:
                description: 'Build without cache'
                required: false
                type: boolean
                default: false

jobs:     
  build-and-publish:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
    steps:
    - uses: actions/checkout@v4

    - id: pre-step
      name: Determine Docker Tags
      run: |
        # Extract and normalize the version/branch name from the git ref
        release_version=$(echo ${GITHUB_REF:10} | tr -d '/' | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]._-')
        
        if [[ "$GITHUB_EVENT_NAME" == "push" || "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
          
          # CASE 1: Version Tag Push (e.g., v1.2.3)
          # Tags applied: <version>, latest, and latest-major (if vX.0.0)
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            tags+=("$release_version" "latest")
            
            # Parse semantic version components
            if [[ "$release_version" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
              major="${BASH_REMATCH[1]}"
              minor="${BASH_REMATCH[2]}"
              patch="${BASH_REMATCH[3]}"
              
              # Add 'latest-major' tag only for new major version releases (vX.0.0)
              # Example: v2.0.0 gets 'latest-major', but v2.0.1 or v2.1.0 do not
              if [[ "$minor" == "0" && "$patch" == "0" ]]; then
                tags+=("latest-major")
                echo "ğŸ‰ Major version release detected: ${release_version}"
              fi
            fi
          
          # CASE 2: Branch Push (e.g., dev, test/feature)
          # Tags applied: <branch-name>
          else
            tags+=("$release_version")
          fi
        else
          echo "Error: Unexpected event type: $GITHUB_EVENT_NAME"
          exit 1
        fi
        
        # Export tags for later steps
        echo "tags=$(IFS=,; echo "${tags[*]}")" >> $GITHUB_OUTPUT
        
        # Display build information
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Docker Image: ${{ vars.REPO_ADDRESS }}/${{ vars.REPO_USER }}/${{ vars.REPO_NAME }}"
        echo "Tags to be applied:"
        for tag in ${tags[@]}; do
          echo "  â€¢ $tag"
        done
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Repo
      uses: docker/login-action@v3
      with:
        username: ${{ vars.REPO_USER }}
        registry: ${{ vars.REPO_ADDRESS }}
        password: ${{ secrets.REPO_TOKEN }}

    - name: Cache Docker layers
      if: ${{ !inputs.no-cache && github.server_url == 'https://github.com' }}
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build and Push Multi-Platform Docker Image
      run: |
        declare -a tags=($(echo "${{ steps.pre-step.outputs.tags }}" | tr "," " "))
        tag_cmd=""
        for tag in "${tags[@]}"; do
          tag_cmd+="-t ${{ vars.REPO_ADDRESS }}/${{ vars.REPO_USER }}/${{ vars.REPO_NAME }}:$tag "
        done
        
        # Determine cache arguments based on workflow input
        if [[ "${{ inputs.no-cache }}" == "true" ]]; then
          echo "ğŸš« Building without cache (as requested)"
          cache_args="--no-cache"
        else
          cache_args="--cache-from type=local,src=/tmp/.buildx-cache --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max"
        fi
        
        # Build and push multi-platform image (amd64 and arm64) with layer caching
        docker buildx build \
          $tag_cmd \
          --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
          --build-arg VCS_REF=$(git rev-parse --short HEAD) \
          --build-arg VERSION=${GITHUB_REF##*/} \
          --label org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
          --label org.opencontainers.image.revision=$(git rev-parse HEAD) \
          --label org.opencontainers.image.version=${GITHUB_REF##*/} \
          --annotation "index:org.opencontainers.image.description=Dynamic sports thumbnail and logo generation API" \
          --annotation "index:org.opencontainers.image.source=https://github.com/sethwv/game-thumbs" \
          --annotation "index:org.opencontainers.image.url=https://github.com/sethwv/game-thumbs" \
          --annotation "index:org.opencontainers.image.title=game-thumbs" \
          --annotation "index:org.opencontainers.image.licenses=MIT" \
          $cache_args \
          --platform linux/amd64,linux/arm64 \
          --provenance=false \
          --push \
          .
        
        # Move cache to avoid growing cache size indefinitely (only if cache was used)
        if [[ "${{ inputs.no-cache }}" != "true" ]]; then
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
        fi
